parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"m4Di":[function(require,module,exports) {
"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function n(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}Object.defineProperty(exports,"__esModule",{value:!0}),exports.Linesegment=exports.Point=void 0;var i=function(){function e(n,i){t(this,e),this.x=n,this.y=i}return n(e,[{key:"distanceTo",value:function(t){var e=t.x-this.x,n=t.y-this.y;return Math.sqrt(e*e+n*n)}},{key:"polarProjection",value:function(t,n){var i=Math.PI/180*t;return new e(this.x+Math.cos(i)*n,this.y+Math.sin(i)*n)}},{key:"translate",value:function(t,e){return this.x+=t,this.y+=e,this}}]),e}();exports.Point=i;var a=function(){function e(n,i){t(this,e),this.a=n,this.b=i}return n(e,[{key:"intersectionWith",value:function(t){var e=this.b.x-this.a.x,n=this.b.y-this.a.y,a=t.b.x-t.a.x,r=t.b.y-t.a.y,s=(-n*(this.a.x-t.a.x)+e*(this.a.y-t.a.y))/(-a*n+e*r),o=(a*(this.a.y-t.a.y)-r*(this.a.x-t.a.x))/(-a*n+e*r);if(s>=0&&s<=1&&o>=0&&o<=1)return new i(this.a.x+o*e,this.a.y+o*n)}}]),e}();exports.Linesegment=a;
},{}],"Ij9n":[function(require,module,exports) {
"use strict";function t(r){for(var a=0,e=0;0===a;)a=Math.random();for(;0===e;)e=Math.random();var o=Math.sqrt(-2*Math.log(a))*Math.cos(2*Math.PI*e);return(o=o/10+.5)>1||o<0?t():(o-.5)*r}Object.defineProperty(exports,"__esModule",{value:!0}),exports.gaussianNoise=t;
},{}],"EtCz":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TurtleState=void 0;var e=require("./geom.js");function n(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var t=function t(){n(this,t),this.location=new e.Point(56,56),this.theta=0,this.lidarLength=100,this.lidarNoise=0,this.lidarMinResolution=1,this.walls=[new e.Linesegment(new e.Point(0,0),new e.Point(150,0)),new e.Linesegment(new e.Point(150,0),new e.Point(150,100)),new e.Linesegment(new e.Point(150,100),new e.Point(0,100)),new e.Linesegment(new e.Point(0,0),new e.Point(0,100)),new e.Linesegment(new e.Point(150,80),new e.Point(130,80)),new e.Linesegment(new e.Point(130,100),new e.Point(130,80))]};exports.TurtleState=t;
},{"./geom.js":"m4Di"}],"hLFY":[function(require,module,exports) {
"use strict";function e(e,r,t){return e<0?e+=t:e>=t&&(e-=t),r[e]}function r(r,t,o){for(var i=[],n=0;n<t;n++){var u=e(n,r,t),s=e(n+o,r,t);u&&s&&(i[n]=s-u)}return i}Object.defineProperty(exports,"__esModule",{value:!0}),exports.derivativeOf=r,exports.positionOverflowingValueFrom=e;
},{}],"d6sW":[function(require,module,exports) {
"use strict";var t=require("./geom.js"),e=require("./noise.js"),a=require("./envsim.js"),l=require("./derivative.js"),o=document.getElementById("rendering"),r=o.getContext("2d");r.lineWidth=1,r.strokeStyle="black",r.fillStyle="black",r.scale(2,2),r.translate(100,100);var i=new a.TurtleState,n={particles:[{location:new t.Point(0,0),theta:0,score:1,uncertainty:Math.pow(10,2)}],estimatedState:function(){for(var e=void 0,a=void 0,l=void 0,o=void 0,r=0;r<this.particles.length;r++){var i=this.particles[r];e=e?(e+i.location.x)/2:i.location.x,a=a?(a+i.location.y)/2:i.location.y,l=l?(l+i.theta)/2:i.theta,o=o?(o+i.uncertainty)/2:i.uncertainty}return{location:new t.Point(e,a),theta:l,uncertainty:o}},features:[],featureDetectionRadius:3,moveTurtleBy:function(t,e){for(var a=0;a<this.particles.length;a++){var l=this.particles[a];l.location.translate(t,e),l.uncertainty=Math.pow(10,2)}this.particles=this.particles.concat([])},rotateTurtle:function(t){for(var e=0;e<this.particles.length;e++){var a=this.particles[e];a.theta+=t,a.uncertainty=Math.pow(10,2)}this.particles=this.particles.concat([])},updateParticleState:function(e){var a=n.estimatedState();if(0===this.features.length)for(var l=0;l<e.length;l++){var o=e[l];this.features.push(a.location.polarProjection(o.angle+a.theta,o.distance))}else{for(var i=0;i<this.particles.length;i++){var s=this.particles[i];s.score=0;for(var c=0;c<this.features.length;c++)for(var h=this.features[c],y=h.x-s.location.x,f=h.y-s.location.y,u=0;u<e.length;u++){var v=e[u],g=new t.Point(0,0).polarProjection(v.angle+s.theta,v.distance);r.beginPath(),r.strokeStyle="gray",r.fillStyle="gray",r.arc(56+s.location.x+g.x,s.location.y+200+g.y,8,0,2*Math.PI),r.stroke(),r.closePath(),r.beginPath(),r.strokeStyle="blue",r.fillStyle="blue",r.arc(56+a.location.x+y,200+a.location.y+f,6,0,2*Math.PI),r.stroke(),r.closePath();var d=Math.abs(g.x-y),P=Math.abs(g.y-f);if(d<10&&P<10){v.identified=!0,s.score+=1;var k=h.distanceTo(s.location),S=a.uncertainty/(a.uncertainty+v.uncertainty);s.uncertainty=(1-S)*a.uncertainty;var p=k+S*(v.distance-k);s.location=h.polarProjection(v.angle+s.theta+180,p)}}}for(var b=void 0,x=0;x<this.particles.length;x++)b=b?(b+this.particles[x].score)/2:this.particles[x].score;this.particles=this.particles.filter(function(t,a,l){return t.score>=b||(console.log("Particle "+a+" got score "+t.score+" from "+e.length+" and will be removed!"),!1)})}}},s={smoothing:2.5,enabled:!1,currentValue:[],process:function(t,e){return this.enabled?this.currentValue[t]?(this.currentValue[t]+=(e-this.currentValue[t])/this.smoothing,this.currentValue[t]):(this.currentValue[t]=e,e):e}};function c(t,e,a,l){var o=t.polarProjection(e,a);r.strokeStyle=l,r.fillStyle=l,r.beginPath(),r.moveTo(t.x,t.y),r.lineTo(o.x,o.y),r.stroke(),r.closePath()}function h(t,e,a,l,o,i,n,s,c){for(var h=0;h<o;h++){var y=l[h];if(y){var f=t+(h+i)%o,u=e,v=u+y*n;r.beginPath(),r.strokeStyle=a,r.fillStyle=a,r.moveTo(f,u),r.lineTo(f,v),r.stroke(),r.closePath()}}r.save(),r.beginPath(),r.strokeStyle="black",r.fillStyle="black",r.moveTo(t,e-c),r.lineTo(t,e+c),r.translate(t,e),r.rotate(-Math.PI/2),r.textAlign="center",r.font="8px Arial",r.fillText(s,0,-5),r.stroke(),r.closePath(),r.restore()}function y(){r.clearRect(-100,-100,1e3,1e3),r.strokeStyle="black",r.fillStyle="black",r.textAlign="left",r.font="8px Arial",r.fillText("Reality",-20,-20),r.strokeStyle="black",r.fillStyle="black",r.beginPath();for(var a=0;a<i.walls.length;a++){var o=i.walls[a];r.moveTo(o.a.x,o.a.y),r.lineTo(o.b.x,o.b.y)}r.stroke(),r.closePath(),r.beginPath(),r.strokeStyle="gray",r.fillStyle="gray",r.arc(i.location.x,i.location.y,8,0,2*Math.PI),r.stroke(),r.closePath(),c(i.location,i.theta,20,"green"),r.strokeStyle="black",r.fillStyle="black",r.textAlign="left",r.font="8px Arial",r.fillText("Turtles model no.F. = "+n.features.length+", no. P = "+n.particles.length,-20,120);for(var y=0;y<n.particles.length;y++){var f=n.particles[y];r.beginPath(),r.strokeStyle="gray",r.fillStyle="gray",r.arc(f.location.x+56,f.location.y+200,8,0,2*Math.PI),r.stroke(),r.closePath(),c(new t.Point(f.location.x+56,f.location.y+200),f.theta,20,"green"),r.strokeStyle="black",r.fillStyle="black",r.textAlign="left",r.font="8px Arial",r.fillText("Uncertainty:",f.location.x+46,f.location.y+170),r.fillText(f.uncertainty.toPrecision(4),f.location.x+46,f.location.y+180)}for(var u=0;u<n.features.length;u++){var v=n.features[u];r.beginPath(),r.strokeStyle="red",r.fillStyle="red",r.arc(v.x-1+56,v.y-1+200,3,0,2*Math.PI),r.stroke(),r.closePath()}for(var g=0,d=[],P=[],k=360/i.lidarMinResolution,S=k/2,p=i.theta;p<i.theta+360;p+=i.lidarMinResolution,g++){for(var b=i.location.polarProjection(p,i.lidarLength),x=void 0,T=0;T<i.walls.length;T++){var m=i.walls[T].intersectionWith(new t.Linesegment(i.location,b));if(m){var w=s.process(g,i.location.distanceTo(m)+(0,e.gaussianNoise)(i.lidarNoise));x?x.distance>w&&(x={distance:w,intersection:m}):x={distance:w,intersection:m}}}if(x){d[g]=x.distance,P[g]=p;var M=i.location.polarProjection(p,x.distance);r.beginPath(),r.strokeStyle="CadetBlue",r.fillStyle="CadetBlue",r.arc(M.x,M.y,2,0,2*Math.PI),r.stroke(),r.closePath(),r.beginPath(),0===g?(r.strokeStyle="green",r.fillStyle="green"):(r.strokeStyle="CadetBlue",r.fillStyle="CadetBlue");var A=200+(g+S)%k,I=50-x.distance;r.moveTo(A,50),r.lineTo(A,I),r.stroke(),r.closePath()}else r.strokeStyle="rgba(128,128,128,0.05)",r.fillStyle="rgba(128,128,128,0.05)",r.beginPath(),r.moveTo(i.location.x,i.location.y),r.lineTo(b.x,b.y),r.stroke(),r.closePath()}r.save(),r.beginPath(),r.strokeStyle="black",r.fillStyle="black",r.moveTo(200,50),r.lineTo(200,-70),r.translate(200,50),r.rotate(-Math.PI/2),r.textAlign="center",r.font="8px Arial",r.fillText("Lidar distance",60,-5),r.stroke(),r.closePath(),r.restore();var j=(0,l.derivativeOf)(d,g,1),V=(0,l.derivativeOf)(j,g,1);h(200,90,"DarkSlateGrey",j,k,S,3,"1st derivative",20),h(200,160,"DarkSlateGrey",V,k,S,15,"2nd derivative",20);for(var B=[],q=0;q<g;q++){var F=(0,l.positionOverflowingValueFrom)(q,j,k),R=(0,l.positionOverflowingValueFrom)(q-1,j,k),C=(0,l.positionOverflowingValueFrom)(q,V,k),L=!1;F&&R&&C&&(R>=0&&F<0?L=!0:R<0&&F>.025&&(L=!0));var O=d[q];if(L&&O){var D=P[q],E=i.location.polarProjection(D,O);B.push({angle:D-i.theta,distance:O,uncertainty:Math.pow(5,2)}),r.beginPath(),r.strokeStyle="red",r.fillStyle="red",r.arc(E.x,E.y,2,0,2*Math.PI),r.stroke(),r.closePath(),r.strokeStyle="lightgray",r.fillStyle="lightgray",r.beginPath(),r.moveTo(i.location.x,i.location.y),r.lineTo(E.x,E.y),r.stroke(),r.closePath();var G=200+(q+S)%k,N=90,U=N-j[q];r.beginPath(),r.strokeStyle="red",r.fillStyle="red",r.arc(G,U,2,0,2*Math.PI),r.stroke(),r.closePath(),G=200+(q+S)%k,U=(N=50)-d[q],r.beginPath(),r.strokeStyle="red",r.fillStyle="red",r.arc(G,U,2,0,2*Math.PI),r.stroke(),r.closePath()}}n.updateParticleState(B)}function f(){y(),window.requestAnimationFrame(f)}window.requestAnimationFrame(f),window.addEventListener("keydown",function(t){if("ArrowUp"===t.key){var e=3*Math.cos(Math.PI/180*i.theta),a=3*Math.sin(Math.PI/180*i.theta);i.location.translate(e,a),n.moveTurtleBy(e,a)}if("ArrowDown"===t.key){var l=-3*Math.cos(Math.PI/180*i.theta),o=-3*Math.sin(Math.PI/180*i.theta);i.location.translate(l,o),n.moveTurtleBy(l,o)}"ArrowLeft"===t.key&&(i.theta-=2,n.rotateTurtle(-2)),"ArrowRight"===t.key&&(i.theta+=2,n.rotateTurtle(2))});
},{"./geom.js":"m4Di","./noise.js":"Ij9n","./envsim.js":"EtCz","./derivative.js":"hLFY"}]},{},["d6sW"], null)
//# sourceMappingURL=main.3b979b51.js.map