parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"m4Di":[function(require,module,exports) {
"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function n(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}Object.defineProperty(exports,"__esModule",{value:!0}),exports.Linesegment=exports.Point=void 0;var i=function(){function e(n,i){t(this,e),this.x=n,this.y=i}return n(e,[{key:"distanceTo",value:function(t){var e=t.x-this.x,n=t.y-this.y;return Math.sqrt(e*e+n*n)}},{key:"polarProjection",value:function(t,n){var i=Math.PI/180*t;return new e(this.x+Math.cos(i)*n,this.y+Math.sin(i)*n)}},{key:"translate",value:function(t,e){return this.x+=t,this.y+=e,this}}]),e}();exports.Point=i;var a=function(){function e(n,i){t(this,e),this.a=n,this.b=i}return n(e,[{key:"intersectionWith",value:function(t){var e=this.b.x-this.a.x,n=this.b.y-this.a.y,a=t.b.x-t.a.x,r=t.b.y-t.a.y,s=(-n*(this.a.x-t.a.x)+e*(this.a.y-t.a.y))/(-a*n+e*r),o=(a*(this.a.y-t.a.y)-r*(this.a.x-t.a.x))/(-a*n+e*r);if(s>=0&&s<=1&&o>=0&&o<=1)return new i(this.a.x+o*e,this.a.y+o*n)}}]),e}();exports.Linesegment=a;
},{}],"Ij9n":[function(require,module,exports) {
"use strict";function t(r){for(var a=0,e=0;0===a;)a=Math.random();for(;0===e;)e=Math.random();var o=Math.sqrt(-2*Math.log(a))*Math.cos(2*Math.PI*e);return(o=o/10+.5)>1||o<0?t():(o-.5)*r}Object.defineProperty(exports,"__esModule",{value:!0}),exports.gaussianNoise=t;
},{}],"EtCz":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TurtleState=void 0;var e=require("./geom.js"),n=require("./noise");function t(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,n,t){return n&&i(e.prototype,n),t&&i(e,t),e}var s=function(){function i(){t(this,i),this.location=new e.Point(56,56),this.theta=45,this.lidarLength=100,this.lidarNoise=0,this.lidarSamples=0,this.lidarMinResolution=1,this.edgeDetectionThreshold=5,this.walls=[new e.Linesegment(new e.Point(0,0),new e.Point(150,0)),new e.Linesegment(new e.Point(150,0),new e.Point(150,100)),new e.Linesegment(new e.Point(150,100),new e.Point(0,100)),new e.Linesegment(new e.Point(0,0),new e.Point(0,100)),new e.Linesegment(new e.Point(150,80),new e.Point(130,80)),new e.Linesegment(new e.Point(130,100),new e.Point(130,80))]}return o(i,[{key:"lidarFrame",value:function(){for(var t=[],i=[],o=0,s=this.theta;s<this.theta+360;s+=this.lidarMinResolution,o++){i[o]=s;for(var a=this.location.polarProjection(s,this.lidarLength),r=void 0,l=0;l<this.walls.length;l++){var h=this.walls[l].intersectionWith(new e.Linesegment(this.location,a));if(h){for(var c=this.location.distanceTo(h)+(0,n.gaussianNoise)(this.lidarNoise),u=0;u<this.lidarSamples;u++){c=(c+(this.location.distanceTo(h)+(0,n.gaussianNoise)(this.lidarNoise)))/2}r?r.distance>c&&(r={distance:c,intersection:h}):r={distance:c,intersection:h}}}r&&(t[o]=r.distance)}return{angles:i,distances:t}}}]),i}();exports.TurtleState=s;
},{"./geom.js":"m4Di","./noise":"Ij9n"}],"hLFY":[function(require,module,exports) {
"use strict";function r(r,e,o){return r<0?r+=o:r>=o&&(r-=o),e[r]}function e(e,o,t,i){var n=r(i-t,e,o),u=r(i+t,e,o);if(n&&u)return(u-n)/(t+1)}function o(r,o,t){for(var i=[],n=0;n<o;n++){for(var u=void 0,v=0,f=t;f>=1;f--){var a=e(r,o,f,n);a&&(u?u+=a:u=a,v++)}i[n]=u?u/v:void 0}return i}Object.defineProperty(exports,"__esModule",{value:!0}),exports.derivativeOf=o,exports.positionOverflowingValueFrom=r;
},{}],"d6sW":[function(require,module,exports) {
"use strict";var t=require("./geom.js"),e=require("./noise.js"),a=require("./envsim.js"),o=require("./derivative.js"),l=document.getElementById("rendering"),r=l.getContext("2d");r.lineWidth=1,r.strokeStyle="black",r.fillStyle="black",r.scale(2,2),r.translate(100,100);var i=new a.TurtleState,n={particles:[{location:new t.Point(0,0),theta:i.theta,score:1,uncertainty:Math.pow(10,2)}],estimatedState:function(){for(var e=void 0,a=void 0,o=void 0,l=void 0,r=0;r<this.particles.length;r++){var i=this.particles[r];e=e?(e+i.location.x)/2:i.location.x,a=a?(a+i.location.y)/2:i.location.y,o=o?(o+i.theta)/2:i.theta,l=l?(l+i.uncertainty)/2:i.uncertainty}return{location:new t.Point(e,a),theta:o,uncertainty:l}},features:[],featureDetectionRadius:3,moveTurtleBy:function(t,a){for(var o=0;o<this.particles.length;o++){var l=this.particles[o];l.location.translate(t+(0,e.gaussianNoise)(3),a+(0,e.gaussianNoise)(3)),l.uncertainty=Math.pow(10,2)}this.particles=this.particles.concat([])},rotateTurtle:function(t){for(var e=0;e<this.particles.length;e++){var a=this.particles[e];a.theta+=t,a.uncertainty=Math.pow(10,2)}this.particles=this.particles.concat([])},updateParticleState:function(e){var a=n.estimatedState();if(0===this.features.length)for(var o=0;o<e.length;o++){var l=e[o];this.features.push({uncertainty:Math.pow(10,2),location:a.location.polarProjection(l.angle+a.theta,l.distance)})}else{for(var i=0;i<this.particles.length;i++){var s=this.particles[i];s.score=0;for(var c=0;c<this.features.length;c++)for(var h=this.features[c],y=0;y<e.length;y++){var f=e[y],v=new t.Point(0,0).polarProjection(f.angle+s.theta,f.distance).translate(s.location.x,s.location.y);if(r.beginPath(),r.strokeStyle="gray",r.fillStyle="gray",r.arc(56+v.x,200+v.y,8,0,2*Math.PI),r.stroke(),r.closePath(),v.distanceTo(h.location)<10){f.identified=!0,r.beginPath(),r.strokeStyle="blue",r.fillStyle="blue",r.arc(56+v.x,200+v.y,6,0,2*Math.PI),r.stroke(),r.closePath(),s.score+=1;var g=h.location.distanceTo(s.location),d=a.uncertainty/(a.uncertainty+f.uncertainty);s.uncertainty=(1-d)*a.uncertainty;var u=g+d*(f.distance-g),P=s.location;s.location=h.location.polarProjection(f.angle+s.theta+180,u),h.location=P.polarProjection(f.angle+s.theta,u)}}}for(var k=void 0,S=0;S<this.particles.length;S++)k=k?(k+this.particles[S].score)/2:this.particles[S].score;this.particles=this.particles.filter(function(t,a,o){return t.score>=k||(console.log("Particle "+a+" got score "+t.score+" from "+e.length+" and will be removed!"),!1)})}}};function s(t,e,a,o){var l=t.polarProjection(e,a);r.strokeStyle=o,r.fillStyle=o,r.beginPath(),r.moveTo(t.x,t.y),r.lineTo(l.x,l.y),r.stroke(),r.closePath()}function c(t,e,a,o,l,i,n,s,c){for(var h=0;h<l;h++){var y=o[h];if(y){var f=t+(h+i)%l,v=e,g=v+y*n;r.beginPath(),r.strokeStyle=a,r.fillStyle=a,r.moveTo(f,v),r.lineTo(f,g),r.stroke(),r.closePath()}}r.save(),r.beginPath(),r.strokeStyle="black",r.fillStyle="black",r.moveTo(t,e-c),r.lineTo(t,e+c),r.translate(t,e),r.rotate(-Math.PI/2),r.textAlign="center",r.font="8px Arial",r.fillText(s,0,-5),r.stroke(),r.closePath(),r.restore()}var h=void 0;function y(){r.clearRect(-100,-100,1e3,1e3),r.strokeStyle="black",r.fillStyle="black",r.textAlign="left",r.font="8px Arial",r.fillText("Reality",-20,-20),r.strokeStyle="black",r.fillStyle="black",r.beginPath();for(var e=0;e<i.walls.length;e++){var a=i.walls[e];r.moveTo(a.a.x,a.a.y),r.lineTo(a.b.x,a.b.y)}r.stroke(),r.closePath(),r.beginPath(),r.strokeStyle="gray",r.fillStyle="gray",r.arc(i.location.x,i.location.y,8,0,2*Math.PI),r.stroke(),r.closePath(),s(i.location,i.theta,20,"green"),r.strokeStyle="black",r.fillStyle="black",r.textAlign="left",r.font="8px Arial",r.fillText("Turtles model no.F. = "+n.features.length+", no. P = "+n.particles.length,-20,120);for(var l=0;l<n.particles.length;l++){var y=n.particles[l];r.beginPath(),r.strokeStyle="gray",r.fillStyle="gray",r.arc(y.location.x+56,y.location.y+200,8,0,2*Math.PI),r.stroke(),r.closePath(),s(new t.Point(y.location.x+56,y.location.y+200),y.theta,20,"green"),r.strokeStyle="black",r.fillStyle="black",r.textAlign="left",r.font="8px Arial",r.fillText("Uncertainty:",y.location.x+46,y.location.y+170),r.fillText(y.uncertainty.toPrecision(4),y.location.x+46,y.location.y+180)}for(var f=0;f<n.features.length;f++){var v=n.features[f];r.beginPath(),r.strokeStyle="red",r.fillStyle="red",r.arc(v.location.x-1+56,v.location.y-1+200,3,0,2*Math.PI),r.stroke(),r.closePath()}for(var g=i.lidarFrame(),d=g.angles.length,u=g.distances,P=g.angles,k=360/i.lidarMinResolution,S=k/2,p=0;p<d;p+=1){var b=i.location.polarProjection(p+i.theta,i.lidarLength),x=u[p];if(x){var T=i.location.polarProjection(p+i.theta,x);r.beginPath(),r.strokeStyle="CadetBlue",r.fillStyle="CadetBlue",r.arc(T.x,T.y,2,0,2*Math.PI),r.stroke(),r.closePath(),r.beginPath(),0===d?(r.strokeStyle="green",r.fillStyle="green"):(r.strokeStyle="CadetBlue",r.fillStyle="CadetBlue");var w=200+(p+S)%k,m=50-x;r.moveTo(w,50),r.lineTo(w,m),r.stroke(),r.closePath()}else r.strokeStyle="rgba(128,128,128,0.05)",r.fillStyle="rgba(128,128,128,0.05)",r.beginPath(),r.moveTo(i.location.x,i.location.y),r.lineTo(b.x,b.y),r.stroke(),r.closePath()}r.save(),r.beginPath(),r.strokeStyle="black",r.fillStyle="black",r.moveTo(200,50),r.lineTo(200,-70),r.translate(200,50),r.rotate(-Math.PI/2),r.textAlign="center",r.font="8px Arial",r.fillText("Lidar distance",60,-5),r.stroke(),r.closePath(),r.restore();var M=(0,o.derivativeOf)(u,d,i.edgeDetectionThreshold),A=(0,o.derivativeOf)(M,d,i.edgeDetectionThreshold);c(200,90,"DarkSlateGrey",M,k,S,5,"1st derivative",20),c(200,160,"DarkSlateGrey",A,k,S,20,"2nd derivative",20);for(var I=[],j="Angle;Distance;1st dvt;2nd dvt;Feature Detected\n",B=0;B<d;B++){var F=(0,o.positionOverflowingValueFrom)(B,M,k),D=(0,o.positionOverflowingValueFrom)(B-1,M,k),R=(0,o.positionOverflowingValueFrom)(B,A,k),q=!1;F&&D&&R&&(D>=0&&F<0&&R<-.3?q=!0:D<0&&F>=0&&R>.3&&(q=!0)),j+=B+";",u[B]&&(j+=Math.round(100*u[B])),j+=";",M[B]&&(j+=Math.round(100*M[B])),j+=";",A[B]&&(j+=Math.round(100*A[B])),j+=";",q&&(j+="Feature"),j+="\n";var L=u[B];if(q&&L){var O=P[B],C=i.location.polarProjection(O,L);I.push({angle:O-i.theta,distance:L,uncertainty:Math.pow(5,2)}),r.beginPath(),r.strokeStyle="red",r.fillStyle="red",r.arc(C.x,C.y,2,0,2*Math.PI),r.stroke(),r.closePath(),r.strokeStyle="lightgray",r.fillStyle="lightgray",r.beginPath(),r.moveTo(i.location.x,i.location.y),r.lineTo(C.x,C.y),r.stroke(),r.closePath();var U=200+(B+S)%k,E=90,V=E-M[B];r.beginPath(),r.strokeStyle="red",r.fillStyle="red",r.arc(U,V,2,0,2*Math.PI),r.stroke(),r.closePath(),U=200+(B+S)%k,V=(E=50)-u[B],r.beginPath(),r.strokeStyle="red",r.fillStyle="red",r.arc(U,V,2,0,2*Math.PI),r.stroke(),r.closePath()}}h=new Blob([j],{type:"text/csv"});var G=document.getElementById("download");G.href=window.URL.createObjectURL(h),G.dowload="snapshot.csv",n.updateParticleState(I)}function f(){y(),window.requestAnimationFrame(f)}window.requestAnimationFrame(f),window.addEventListener("keydown",function(t){if("ArrowUp"===t.key){var e=3*Math.cos(Math.PI/180*i.theta),a=3*Math.sin(Math.PI/180*i.theta);i.location.translate(e,a),n.moveTurtleBy(e,a)}if("ArrowDown"===t.key){var o=-3*Math.cos(Math.PI/180*i.theta),l=-3*Math.sin(Math.PI/180*i.theta);i.location.translate(o,l),n.moveTurtleBy(o,l)}"ArrowLeft"===t.key&&(i.theta-=2,n.rotateTurtle(-2)),"ArrowRight"===t.key&&(i.theta+=2,n.rotateTurtle(2))});
},{"./geom.js":"m4Di","./noise.js":"Ij9n","./envsim.js":"EtCz","./derivative.js":"hLFY"}]},{},["d6sW"], null)
//# sourceMappingURL=main.b6b5db2e.js.map